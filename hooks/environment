#!/bin/bash

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_TRIVY_IMAGE} ]; then
	export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_TRIVY_IMAGE=aquasec/trivy
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_TRIVY_VERSION} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_TRIVY_VERSION=0.29.2
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_SCAN_TYPE} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_SCAN_TYPE=image
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_TARGET_IMAGE} ] && [ ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_SCAN_TYPE} == "image" ]; then
    buildkite-agent annotate --style "error" "Image scan type specified without specifying a target image."
    exit 1
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_FORMAT} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_FORMAT=table
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_MOUNT} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_MOUNT=/var/run/docker.sock:/var/run/docker.sock
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_VULN_TYPE} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_VULN_TYPE=os,library
fi

if [ -z ${BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_SEVERITY} ]; then
    export BUILDKITE_PLUGIN_BUILDKITE_TRIVY_PLUGIN_SEVERITY=UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL
fi